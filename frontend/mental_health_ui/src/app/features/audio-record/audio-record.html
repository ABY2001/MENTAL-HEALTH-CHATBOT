

<div class="chat-page common-color">
  <div class="chat-container">
    <div class="chat-header">
      <div class="header-top row">
        <div class="col-6 ">
          <img src="/logo.png" alt="Logo" class="app-logo">
        </div>
        <div class="col-6 text-end ">
           <button class="history-btn" (click)="loadChatHistory()" title="Load previous chats">
            ğŸ“œ Chat History
          </button>
          <button class="new-chat-btn" (click)="newChat()" title="Start a new conversation">
            âœ¨ New Chat
          </button>
        </div>
      </div>
      
      <!-- <div class="emotion-status">
        {{ emotionStatus }}
      </div> -->
    </div>

    <!-- Chat History Sidebar -->
    <div class="chat-history-panel" *ngIf="showChatHistory">
      <div class="history-header">
        <h3>ğŸ“œ Chat History</h3>
        <button class="close-btn" (click)="closeChatHistory()">âœ•</button>
      </div>

      <div class="history-content">
        <!-- Loading State -->
        <div *ngIf="chatHistoryLoading" class="history-loading">
          <div class="spinner"></div>
          <p>Loading chat history...</p>
        </div>

        <!-- Empty State -->
        <div *ngIf="!chatHistoryLoading && chatHistory.length === 0" class="history-empty">
          <p>No chat history yet</p>
          <p class="empty-note">Start chatting to build your history</p>
        </div>

        <!-- Chat List -->
        <div *ngIf="!chatHistoryLoading && chatHistory.length > 0" class="history-list">
          <div *ngFor="let chat of chatHistory" class="chat-item" (click)="loadPreviousChat(chat)">
            <div class="chat-item-header">
              <span class="emotion-badge" [ngClass]="'emotion-' + chat.emotion.toLowerCase()">
                {{ chat.emotion }}
              </span>
              <span class="timestamp">{{ chat.created_at | date:'short' }}</span>
              
            </div>
            <p class="chat-preview">{{ chat.user_message | slice:0:60 }}...</p>
            <button class="delete-chat-btn" (click)="deleteIndividualChat(chat.id, chat.user_message)">
              ğŸ—‘ï¸
            </button>
          </div>
        </div>
      </div>

      <!-- Delete History Button -->
      <div class="history-footer" *ngIf="chatHistory.length > 0">
        <button class="delete-history-btn" (click)="deleteAllChats()">
          ğŸ—‘ï¸ Delete All Chats
        </button>
      </div>
    </div>

    <!-- Messages Container -->
    <div class="messages-container" #messagesContainer>
      <div 
        *ngFor="let message of messages" 
        class="message"
        [class.user]="message.isUser"
        [class.bot]="!message.isUser">
        <div class="message-bubble">
          <div class="message-text fw-bolder">{{ message.text }}</div>
          <div 
            *ngIf="message.emotion && message.isUser" 
            class="emotion-badge fw-normal"
            [ngClass]="getEmotionClass(message.emotion)">
            Detected: {{ message.emotion }}
          </div>
          <div class="message-time">{{ message.time }}</div>
        </div>
      </div>

      <div class="typing-indicator" [class.active]="isTyping">
        <div class="typing-dots">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
    </div>

    <!-- Audio Preview Modal -->
    <div class="audio-preview-modal" *ngIf="showAudioPreview">
      <div class="preview-content">
        <div class="preview-header">
          <h3>ğŸ¤ Review Your Recording</h3>
          <p>Listen before sending</p>
        </div>

        <div class="audio-player-container">
          <audio 
            #audioPlayer
            [src]="audioURL" 
            controls
            class="audio-player">
          </audio>
          <div class="recording-duration">
            Duration: {{audioPreviewDuration}}
          </div>
        </div>

        <div class="preview-actions">
          <button class="btn-cancel" (click)="cancelRecording()">
            <span class="icon">ğŸ—‘ï¸</span>
            Delete & Re-record
          </button>
          <button class="btn-send" (click)="confirmSendAudio()">
            <span class="icon">âœ“</span>
            Send Recording
          </button>
        </div>
      </div>
    </div>

    <!-- Input Area -->
    <div class="input-area">
      <!-- Recording Status - Shows ONLY when recording -->
      <div class="recording-status" *ngIf="isRecording">
        <div class="recording-pulse"></div>
        <span class="recording-time">{{ recordingTime }}</span>
        <span class="recording-label">Recording...</span>
      </div>

      <!-- Text Input - Shows when NOT recording -->
      <textarea
        *ngIf="!isRecording"
        [(ngModel)]="messageInput"
        (keydown)="onKeyDown($event)"
        placeholder="Type your message..."
        rows="1"
        class="message-input"
      ></textarea>

      <div class="action-buttons">
        <button 
          class="mic-btn" 
          [class.recording]="isRecording"
          (click)="toggleRecording()"
          [disabled]="showAudioPreview"
          [title]="isRecording ? 'Stop Recording' : 'Record voice message'">
          {{ isRecording ? 'â¹' : 'ğŸ™ï¸' }}
        </button>
        <button 
          class="send-btn" 
          (click)="sendMessage()"
          [disabled]="!messageInput.trim() || isRecording || showAudioPreview"
          title="Send message">
          â¤
        </button>
      </div>
    </div>
  </div>
</div>